{% extends 'base.html' %}

{% block title %}Atendimento{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        
        <div class="card mb-4 border-primary border-start border-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h4 class="mb-1 text-primary fw-bold">
                            <i class="bi bi-person-vcard me-2"></i>{{ agendamento.paciente.usuario.get_full_name|default:agendamento.paciente.usuario.username }}
                        </h4>
                        <span class="badge bg-secondary-subtle text-secondary-emphasis border">
                            <i class="bi bi-upc-scan me-1"></i>CPF: {{ agendamento.paciente.cpf }}
                        </span>
                        <span class="badge bg-secondary-subtle text-secondary-emphasis border ms-1">
                            <i class="bi bi-cake2 me-1"></i>Nasc: {{ agendamento.paciente.data_nascimento|date:"d/m/Y" }}
                        </span>
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">Hor√°rio Agendado</small>
                        <span class="fs-5 fw-bold">{{ agendamento.data_horario|date:"H:i" }}</span>
                    </div>
                </div>
                <hr>
                <p class="mb-0"><strong class="text-muted">Queixa Inicial:</strong> {{ agendamento.observacoes|default:"N√£o informada" }}</p>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-body py-3">
                <h5 class="mb-0 fw-bold"><i class="bi bi-file-medical me-2"></i>Registro Cl√≠nico</h5>
            </div>
            <div class="card-body p-4">
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold text-primary">üìù Hist√≥rico / Anamnese</label>
                        {{ form.historico }}
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold text-primary">üíä Prescri√ß√£o / Receita</label>
                        
                        <div class="input-group mb-2">
                            <span class="input-group-text bg-body-tertiary"><i class="bi bi-search"></i></span>
                            <input type="text" list="lista-remedios" id="input-remedio" class="form-control" placeholder="Buscar medicamento...">
                            <button type="button" onclick="adicionarRemedio()" class="btn btn-outline-primary">
                                <i class="bi bi-plus-lg"></i> Adicionar
                            </button>
                        </div>

                        <datalist id="lista-remedios">
                            {% for remedio in lista_medicamentos %}
                                <option value="{{ remedio.nome }}">
                            {% endfor %}
                        </datalist>

                        {{ form.prescricao }}
                        <div class="form-text">O texto pode ser editado livremente.</div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'painel_medico' %}" class="btn btn-outline-secondary px-4">Cancelar</a>
                        <button type="submit" class="btn btn-success btn-lg px-5 fw-bold shadow">
                            <i class="bi bi-check2-circle me-2"></i>Finalizar Atendimento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function adicionarRemedio() {
        var input = document.getElementById("input-remedio");
        var textarea = document.getElementById("id_prescricao");
        var remedio = input.value;

        if (remedio) {
            var prefixo = textarea.value ? "\n" : "";
            textarea.value += prefixo + "‚Ä¢ " + remedio;
            input.value = "";
            input.focus();
        }
    }
</script>

<style>
    textarea { 
        width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;
        background-color: var(--bs-body-bg); color: var(--bs-body-color);
        min-height: 120px;
    }
    textarea:focus { border-color: var(--bs-primary); outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 148, 136, 0.25); }
</style>
{% endblock %}