<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel do M√©dico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos das Fotos */
        .foto-nav {
            width: 35px; height: 35px; border-radius: 50%; object-fit: cover; 
            border: 2px solid rgba(255,255,255,0.8);
        }
        .foto-lista {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover; 
            border: 1px solid #dee2e6; margin-right: 12px;
        }
        a.perfil-link { text-decoration: none; color: white; }
        
        /* Anima√ß√£o suave para quem est√° na sala de espera */
        .status-espera {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">√Årea do M√©dico</a>
            
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'editar_perfil' %}" class="d-flex align-items-center gap-2 perfil-link">
                    {% if user.foto %}
                        <img src="{{ user.foto.url }}" class="foto-nav">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random" class="foto-nav">
                    {% endif %}
                    <span class="fw-bold">Dr(a). {{ user.first_name|default:user.username }}</span>
                </a>

                <form action="{% url 'logout' %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-light text-primary fw-bold">Sair</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container">
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="row mb-4">
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="card-title">Resumo do Dia</h5>
                            <p class="text-muted small mb-0">Status dos atendimentos</p>
                        </div>
                        <div style="width: 90px; height: 90px;">
                            <canvas id="meuGrafico"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm h-100 border-0 bg-transparent">
                    <div class="card-body p-0 ps-md-3 d-flex flex-column justify-content-center">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h3>Minha Agenda</h3>
                                <p class="text-muted mb-0">Acompanhe a chegada dos pacientes.</p>
                            </div>
                            <div class="col-md-6 mt-3 mt-md-0">
                                <form method="get" class="d-flex gap-2">
                                    <input type="text" name="q" class="form-control" placeholder="Nome ou CPF..." value="{{ request.GET.q|default:'' }}"> 
                                    <button type="submit" class="btn btn-primary">üîç</button>
                                    {% if request.GET.q %}
                                        <a href="{% url 'painel_medico' %}" class="btn btn-outline-secondary">Limpar</a>
                                    {% endif %}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                {% if agendamentos %}
                    <table class="table table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Paciente</th>
                                <th>Status Atual</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for agenda in agendamentos %}
                            <tr>
                                <td>
                                    <span class="fs-5 fw-bold">{{ agenda.data_horario|date:"H:i" }}</span>
                                    <br> <small class="text-muted">{{ agenda.data_horario|date:"d/m" }}</small>
                                </td>
                                
                                <td class="d-flex align-items-center">
                                    {% if agenda.paciente.usuario.foto %}
                                        <img src="{{ agenda.paciente.usuario.foto.url }}" class="foto-lista">
                                    {% else %}
                                        <img src="https://ui-avatars.com/api/?name={{ agenda.paciente.usuario.username }}&background=random" class="foto-lista">
                                    {% endif %}
                                    
                                    <div>
                                        <strong>{{ agenda.paciente.usuario.get_full_name|default:agenda.paciente.usuario.username }}</strong>
                                        <br>
                                        <small class="text-muted">CPF: {{ agenda.paciente.cpf }}</small>
                                    </div>
                                </td>
                                
                                <td>
                                    {% if agenda.status == 'AGENDADO' %}
                                        <span class="badge bg-warning text-dark border border-warning">üè† Em Casa</span>
                                    
                                    {% elif agenda.status == 'AGUARDANDO' %}
                                        <span class="badge bg-primary fs-6 shadow-sm status-espera">
                                            üõãÔ∏è Sala de Espera
                                        </span>
                                    
                                    {% elif agenda.status == 'REALIZADO' %}
                                        <span class="badge bg-success">Atendido</span>
                                    {% else %}
                                        <span class="badge bg-danger">Cancelado</span>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    {% if agenda.status == 'AGENDADO' or agenda.status == 'AGUARDANDO' %}
                                        <a href="{% url 'realizar_atendimento' agenda.id %}" class="btn btn-sm btn-success fw-bold">
                                            ‚úÖ Chamar / Atender
                                        </a>
                                    {% elif agenda.status == 'REALIZADO' %}
                                        <a href="{% url 'visualizar_prontuario' agenda.id %}" class="btn btn-sm btn-info text-white">
                                            üìÑ Ver Prontu√°rio
                                        </a>
                                    {% else %}
                                        <button class="btn btn-sm btn-secondary" disabled>Arquivado</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="text-center py-5">
                        <h4 class="text-muted">Nenhum paciente na lista.</h4>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        const ctx = document.getElementById('meuGrafico');
        if (ctx) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Aguardando', 'Atendidos', 'Cancelados'],
                    datasets: [{
                        data: [{{ total_agendado|default:0 }}, {{ total_realizado|default:0 }}, {{ total_cancelado|default:0 }}],
                        backgroundColor: ['#ffc107', '#198754', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>